# 8 监控

将系统拆分成更小的、细粒度的服务有很多的好处。然而，这样也增加了监控复杂性。接下来我们看下，细粒度的系统在系统监控和定位上遇到的挑战，和一些应对办法。

监控小的服务，聚合起来看整体。

## 1 单一服务，单一服务器

我们要监控主机资源情况，监控服务器日志，监控应用程序日志。

## 2 单一服务，多个服务器

## 3.多个服务，多个服务器

从系统指标到应用日志，集中收级和聚合尽可能多的数据。

## 4 日志

使用单独的日志系统。

## 5 多个服务的指标跟踪

多个服务的情况下，我们需要监控每个主机的指标，也需要聚合起来看下综合指标。指标可以帮助我们决定什么时候需要扩容和缩容。

## 6 服务指标

哪些算是服务指标呢？例如服务响应时间和错误率，当然还包括服务处理的业务指标。

监控服务指标的作用有几个，首先，可以帮助我们了解用户如何使用系统，以帮助我们改进系统。其次，可以帮助我们识别出哪些功能未被使用。最后，我们当前可能很难知道哪些数据是有用的。所以，尽可能的监控服务指标。

## 7 综合监控

我们可以通过定义正常的cpu级别，或系统的响应时间，来判断系统是否健康。如果我们监控的指标超出正常范围，可以触发警报。

但是这些测量结果距离我们真正关心的内容还是有一定距离，即系统是否正常工作。服务间的交互越发杂，就越难回答这个问题。为了解决这个问题，我们可以使用**合成事务**来确保系统行为在语义上的正确性，这种技术被称为语义监控。使用这样合成事务执行语义监控的方式，比使用低层指标的告警更能表明系统的问题。

### 实现语义监控

我们的系统已经开放了启动测试和查看所需要的钩子，所以，我们可以在运行的系统上运行这些测试子集，作为系统语义监控的一种方式。

这种方式需要消息的准备数据以满足测试，并且，必须要小心的保证不能触发问题。

## 8 关联标识

用户最终看到的任何功能都是由大量的服务配合提供，一个初始调用可能最终触发多个下游服务。在这种情况下，监控就变得相当困难，尤其是一个请求生成的调用链是以异步的方式触发事件。

这种情况下，一个非常有用的方法就是关联标识。在触发第一个调用时生成GUID，然后传递给后续使用。这样可以对事件的整个调用链进行跟踪。

## 9 级联

网络中，一个或少数几个节点或连线的失效会通过节点之间的耦合关系引发其他节点也发生失效，进而产生*级联*效应，最终导致相当一部分节点甚至整个网络的崩溃，这种现象就称为**级联失效**。

因此，监控系统间的集成点非常关键。每个服务实例都应该追踪其下游服务的健康状态。我们也应该将这些信息汇总，形成一个整体的画面。

断路器可以更优雅的处理**级联故障**和**功能降级**。

## 10 标准化

监控领域的标准化至关重要，服务之间使用多个接口，以不同的方法为用户提供功能，你需要以整体的视角来查看系统。因此，我们要对系统内的服务以标准化的方式记录日志。

## 11 考虑受众

## 12 未来

我们不再为不同类型的指标提供专门的工具链， 而是提供伸缩性很好的更为通用的事件路由系统。 这些系统能提供更多的灵活性， 同时还能简化我们的架构。 

## 13 小结

汇总本节中内容，形成方便试试的建议。

+ 对每个服务而言
  + 最低限度要跟踪请求响应时间。做好之后，可以开始跟踪错误率和应用程序级的指标。
  + 最低限度要跟踪下游服务的健康状态。包括下游调用响应时间，最好能跟踪错误率。
  + 标准化如何收集指标和存储指标。
  + 如果可能，以标准的格式将日志记录在一个标准的位置。如果每个服务器有不同的方式，聚合会非常痛苦。
  + 监控底层操作系统，这样可以做容量规划。
+ 对系统而言
  + 聚合CPU之类的主机层次的指标和应用程序级的指标。
  + 确保指标存储工具可以在系统和服务级别做聚合，同时可以查看单台主机情况。
  + 确保指标存储工具可以维护足够长的时间。
  + 考虑使用**标准化关联标识**。
  + 了解什么样的情况需要行动， 并根据这些信息构造相应的警报和仪表盘。
  + 调查对各种指标聚合方式做统一化的可能性。

主要考虑监控什么？如何标准化收级日志？如何处理日志帮助我们改善系统和修复问题？