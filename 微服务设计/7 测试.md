# 7 测试

如何高效且有效的测试分布式系统的功能依然是一个挑战。本章会剖析一下测试细粒度系统所面临的问题和挑战，并提出一些解决方案，帮助大家更有信心的发布新功能。

## 1 测试类型

测试的覆盖面很广，了解测试有哪些不同的类型，可以帮助我们实现尽早交付软件和保持搞质量软件之间的平衡。

![1585701590367](D:\document\typora\1585701590367.png)

在上面的象限中，处于底部的测试是面向技术的测试，他可以帮助开发人员构建系统，并且大都可以自动化，例如小范围的单元测试和性能测试。

不同类型的系统各类测试的占比是有差别的。但是放弃大规模的手工测试，尽可能的使用自动化测试是当前的趋势。在深入微服务之前，应该解决大量手工测试的问题，因为我们无法快速验证软件。

接下来我们将讨论每种自动化测试的类型需要的比例。

## 2 测试范围

“测试金字塔”的模型，有助于我们思考不同测试应该覆盖的范围，还可以帮助我们思考不同测试类型应该投入的比例。他分为单元测试、服务测试、用户界面测试三层。

![1586305323813](D:\document\typora\1586305323813.png)

### 2.1 单元测试

单元测试通常只测试一个函数和方法的调用。通过测试**驱动开发**写的测试用例和基于属性的测试技术所产生的测试都属于。

单元测试是帮助开发人员的，是面向技术而非面向业务的，我们通过他来捕获大量缺陷。这些测试的目的是，能够对功能是否正常给出快速的反馈，因此，单元测试在代码重构中式非常重要的。

### 2.2 服务测试

多服务的系统，一个服务测试测试只测试一个服务的功能。这样，可以提高测试的隔离性，便于快速定位问题。为了达到这种隔离性，我们需要给合作者打桩。

### 2.3 端到端测试

端到端测试就是用户界面测试，他会覆盖大范围的产品代码。伴随着覆盖范围的增大，使用微服务过程中的负面作用也会随之到来。

### 2.4 权衡

在使用这个金字塔时，应该了解到越靠近金字塔的顶端，测试覆盖的范围越大，同时我们对被测试后的功能也越有信心。而缺点是，因为需要更长的时间运行测试，所以反馈周期会变长。并且当测试失败时 比较难定位是哪个功能被破坏。而越靠近金字塔的底部，一般来说测试会越快，所以反馈周期也会变短，测试失败后更容易定位被破坏的功能，持续集成的构建时间也很短。

当范围更大的测试 （比如服务测试或者端到端测试） 失败以后，我们会尝试写一个单元测试来重现问题，以便将来能够以更快的速度捕获同样的错误。我们通过这种方式来持续地缩短反馈周期。 

### 2.5 比例

一个好的经验法则是顺着金字塔向下，下面一层的测试数量要比上面一层多一个数量级。有时我们需要根据反馈的周期来调整测试占比。

一种常见的测试反模式被称为测试甜筒或倒金字塔。在这种反模式中， 有一些甚至没有小范围的测试， 只有大范围的测试。 这些项目的测试运行起来往往极度缓慢， 反馈周期很长。 如果把这些缓慢的测试作为持续集成的一部分， 那就很难做到多次构建。 而长时间的构建也意味着当提交有错误时， 需要很长一段时间才能发现这个问题。

## 3 实现服务测试

服务测试只测试一个单独的服务功能，为了隔离其他相关的服务，需要一种方法给所有外部合作者打桩。

### 3.1 mock还是打桩

打桩就是为被测服务的请求创建一些有预设响应的打桩服务。另一种方式是采用mock，mock会验证本身是否被正确调用，如果没有，测试便失败。

mock和打桩的区别？

### 3.2 智能打桩服务

一些工具可以避免自己去启动打桩服务。

## 4 微妙的端到端测试

在微服务中，界面展示的一个功能往往涉及多个服务。所以，运行测试需要部署多个服务。这种测试的覆盖面更大，更能让我们对系统有信息。但是，测试运行起来比较慢，定位失败也更困难。

一个不成熟的方案是，直接在客户流水线的最后增加这些测试。当多个服务都需要测试上线的时候，这个方案就回出现问题。另一个更好的方案是，让多个流水线测试接入到一个独立的端到端测试，这样任何一个服务的构建，都会触发端到端的测试。

## 6 脆弱的测试

随着测试范围的扩大，纳入测试服务的数量也回增加。这些服务可能测试失败，但是这种失败不是因为功能被破坏了，而是由其他问题造成。例如，其中一个服务的停止，或者网络故障等等。

包含在测试中的服务越多，测试就会越脆弱，不确定性也越强。如果测试失败后，想通过在运行一次通过测试，那么这种测试就是脆弱的。脆弱的测试会导致真正问题的隐藏，是问题堆积。

当发现脆弱测试的时候，我们应该尽可能的去解决这个问题。如果暂时不能解决，需要记录下来，并将其从测试中删除。

