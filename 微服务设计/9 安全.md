# 9 安全

。。。

## 1 身份验证和授权

在安全领域中，身份认证是确定他是谁的过程，授权是将身份主体映射到他可以进行的操作中。在分布式系统中身份要有单一的标识，且只验证一次。

### 1.1 常见的单点登录

身份认证和授权的一种常用方式就是使用某种形式的SSO解决方案。在企业级领域中占据统治地位的 SAML 和 OpenID Connect。OpenID Connect 已经成为了 OAuth 2.0 具体实现中的一个标准。

当主体试图访问一个资源的时候，就会被重定向到身份认证那里进行身份验证。一旦身份提供者确认主体已经通过验证，就会发送消息给服务提供者，服务提供者决定是否允许他访问资源。

这个身份提供者可能是一个外部系统，更多情况下是组织内的系统。对企业来说，通常由自己的身份提供者，他会连接到公司的**目录服务**。目录服务可能是LDAP，他存储着主体信息。通常情况下目录服务和身份提供者是一个系统。

OpenAM、CAS

### 1.2 单点登录网关

在微服务系统中，每个服务可以自己处理如何重定向到身份提供者，这样就存在大量的重复工作。我们可以使用共享库解决这个问题，但是我们要避免共享库带来的耦合性问题。更为合适的做法是使用网关作为代理，而不是每一个服务与身份提供者握手。

这个方案有几个问题。首先，我们需要解决下游服务接收身份信息的问题，例如用户名和角色。我们将身份认证的职责移到网关，在服务中定位问题就会变得困难。他会带来一种虚假的安全感，依靠网关来处理每一步的安全措施，当网关故障后所有安全方式都失效。当网关承担了越来越多的功能，他就可能称为一个耦合点。

### 1.3 细粒度的授权

我们应该倾向于使用粗粒度的角色，围绕着组织的工作方式进行建模。

网关可以提供有效的粗粒度的验证，比如，阻止未登录的用户访问后台程序。网关也可以在验证完成时获取主体信息，进行细粒度的决定。但是，通常这些细粒度的决定应该由微服务自身来决定。

## 2 服务间的身份验证和授权

### 2.1 在边界内允许一切

我们的第一选择是，在边界内对服务的调用都是默认可信的。这种方式在受到攻击的时候很可能出现问题，我们请求被篡改，或者通过其他方式调用服务等。因此，隐式的信任模型具有一定的风险。

### 2.2 http(s)基本身份验证

https可以防止窃听和篡改数据。当然，使用http依旧存在一些问题。首先，SSL证书的管理在管理多台服务器会出现问题。其次，SSL之上的流量不能被反向代理服务器缓存。

### 2.3 使用SAML或OpenIDConnect

如果我们已经在使用openID作为身份认证和授权的手段，我们可以在服务间的交互使用他们。这样做的好处是把服务的访问控制集中在中央目录服务器。

这样做就意味着，我们要为客户端服务创建账户，而服务用于获取身份信息，来控制访问权限。这也是现在普遍采用的方式。

### 2.4 客户端证书

### 2.5 HTTP之上的HMAC

### 2.6 API密钥

API 密钥允许服务识別出是谁在进行调用， 然后对他们能做的进行限制。具体该如何使用 API 密钥方式来处理你的微服务 N的访问， 取决于你所使用的具体技术。

### 2.7 代理问题

有一种安全漏洞叫作混淆代理人问题，指的是在服务间通信的上下文中， 攻击者采用一些措施欺骗代理服务， 让它调用其下游服务， 从而做到一些他不应该能做的事情。

## 3 静态数据的安全



