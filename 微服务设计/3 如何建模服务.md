# 3 如何建模服务

我们将要讨论如何确定服务之间的边界，已经最大化微服务的好处，避开微服务的劣势。我们会以线上零售商MusicCorp为示例进行讲解。

## 1 MusicCorp简介

## 2 什么样的服务是好服务

松耦合与高内聚是衡量微服务的标准。这两个概念在很多地方被广泛的使用，例如面向对象编程中。我们讨论下这两概念在微服务中的含义。

### 2.1 松耦合

如果做到的服务之间的松耦合，我们在修改一个服务的时候，就不应该修改另一个服务。使用微服务很重要的一点就是，能够独立的修改和部署单个服务，而不需要修改系统的其他部分。

什么会导致紧耦合呢，典型错误就是使用了紧耦合的集成方式。

一个松耦合的服务应该尽可能少的知道与他协作的服务的信息。这也就意味着，应该限制两个服务之间不通调用形式的数量，除了性能问题之外，过度通信可能会导致紧耦合。

### 2.2 高内聚

我们希望把相关的行为聚集在一起，不相关的放在别处。因为这样我们在改变某个行为的时候，就可以做到在一处进行修改，从而尽快的发布服务。所以，找到问题域的边界可以确保相关的行为放在一起，并且他们会和其他边界以尽量松耦合的方式进行通信。

## 3 限界上下文

限界上下文是“领域驱动”中提出的概念，他认为给定领域中包含多个限界上下文，而每个限界上下文可以包含两部分，一部分需要与外部通信，一部分不需要。每个上下文中都有明确的接口，该接口决定了他会暴露那些模型给其他上下文。

一个限界上下文就是一个由显式**边界**限定的特定职责。如果向从一个限界上下文获取信息，就需要使用模型与显式边界进行通信。

让我们回到 MusicCoip 的业务上来， 其业务领域涉及运营的方方面面。 它涵盖了从仓储到前台、 从财务到订单的所有元素。 这些元素就是领域。

### 3.1 共享隐藏模型

不同的限界上下文存在共享的模型，但是这些模型一般存在两种表示方式，内部模型和外部模型。这里将的共享模型指的就是外部模型，这样可以避免紧耦合的风险。

并且，在不同的限定上下文中，同一个业务术语可能对应不同意义，也同时对用这不同的模型。

### 3.2 模块和服务

在同一个服务内使用模块来减少彼此的耦合是一种不错的选择，我们一旦发现了领域内部的限界上下文，一定要使用模块对其建模，同时使用共享和隐藏模型。这些模块边界就可以称为绝佳的微服务候选。一般来讲，微服务应该清晰和限界上下文保持一致。

熟练之后， 就可以省掉在单块系统中先使用模块的这个步骤， 而直接使用单独的服务。 然而对于一个新系统而言， 可以先使用一段时间的单块系统， 因为如果服务之间的边界搞错了， 后面修复的代价会很大。 所以最好能够等到系统稳定下来之后， 再确定把哪些东西作为一个服务划分出去。 

### 3.3 过早划分

过早将一个系统划分成为微服务的代价非常高， 尤其是在面对新领域时。 很多时候， 将一个已有的代码库划分成微服务， 要比从头开始构建微服务简单得多。

## 4 业务功能

我们思考组织内的限界上下文时，不应该从共享数据的角度来考虑，应该从上下文能够提供的功能考虑。但是为了实现功能，只考虑模型很容易导致贫血的、基于CRUD的服务。

建模服务时，应该将功能作为关键操作提供给其他协作的服务。

## 5 逐步划分上下文

逐步划分的方式，主要是让我们一开始识别出粗颗粒都的上下，而这些上下文可能又包含嵌套的上下文，我们在逐步的识别这些嵌套的上下文。

对于这种嵌套的上下文，有两种处理方式，一种是嵌套的上下文对外不可见，两一种是直接将外部上下文拆成小的上下文。很难手这两种那个更好，但是我们可以根据我们的组织架构来决定是拆解还是保持一个。

## 6 关于业务概念的沟通

*微服务之间如何就同一个业务概念进行通信， 也是一件很重要的事情。 基于业务领域的软件建模不应该止于限界上下文的概念。 在组织内部共享的那些相同的术语和想法， 也应该被反映到服务的接口上。 以跟组织内通信相同的方式， 来思考微服务之间的通信形式是非常有用的。 事实上， 通信形式在整个组织范围内都非常重要 。*

## 7 技术边界

基于一些事实可以看出，前面提到的按照地理位置或者组织结构对单块系统进行划分是很合理的，如果不是按照业务进行垂直划分，而是对API进行水平切分，可能会导致更多的问题。

## 8 小结

1.什么是一个好的服务？

2.如何构建？

3.怎样划分服务？